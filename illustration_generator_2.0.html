<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuthImageSystem</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background-color: #f5f5f9;
            color: #4a4a68;
            line-height: 1.6;
            padding: 2rem;
            max-width: 800px;
            margin: 0 auto;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #4a4a68;
            margin-bottom: 1rem;
        }

        h3 {
            font-size: 1.2rem;
            font-weight: 500;
            color: #4a4a68;
            margin: 0.5rem 0;
        }

        p {
            font-size: 0.9rem;
            color: #6b6b8c;
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: #4a4a68;
            margin-bottom: 0.25rem;
        }

        input, select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d1e0;
            border-radius: 8px;
            background-color: #ffffff;
            font-size: 0.9rem;
            color: #4a4a68;
            margin-bottom: 1rem;
            transition: border-color 0.2s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #a3a8f0;
            box-shadow: 0 0 0 3px rgba(163, 168, 240, 0.1);
        }

        input:disabled, select:disabled {
            background-color: #f0f0f5;
            cursor: not-allowed;
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease, transform 0.1s ease;
        }

        button:hover {
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(0);
        }

        .primary-btn {
            background-color: #a3a8f0;
            color: #ffffff;
        }

        .primary-btn:hover {
            background-color: #8b90e8;
        }

        .danger-btn {
            background-color: #f28b82;
            color: #ffffff;
        }

        .danger-btn:hover {
            background-color: #e57373;
        }

        .secondary-btn {
            background-color: #b0e0e6;
            color: #4a4a68;
        }

        .secondary-btn:hover {
            background-color: #9acdd3;
        }

        .logout-btn {
            background-color: #ffdab9;
            color: #4a4a68;
        }

        .logout-btn:hover {
            background-color: #ffcc99;
        }

        .tab-links {
            list-style: none;
            display: flex;
            gap: 1rem;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid #d1d1e0;
        }

        .tab-links li a {
            display: inline-block;
            padding: 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: #6b6b8c;
            text-decoration: none;
            transition: color 0.2s ease;
        }

        .tab-links li a:hover {
            color: #a3a8f0;
        }

        .tab-links li a.active {
            color: #a3a8f0;
            border-bottom: 2px solid #a3a8f0;
        }

        .tab-content > div {
            display: none;
        }

        .tab-content > div.active {
            display: block;
        }

        .output {
            padding: 0.75rem;
            font-size: 0.9rem;
        }

        .output div[style*="color:green"] {
            color: #81c784;
        }

        .output div[style*="color:red"] {
            color: #f28b82;
        }

        .output div[style*="color:blue"] {
            color: #a3a8f0;
        }

        #image_output img, #history_output img {
            max-width: 200px;
            border-radius: 8px;
            margin: 0.5rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .session-container {
            border-bottom: 1px solid #d1d1e0;
            padding-bottom: 1rem;
            margin-bottom: 1rem;
        }

        .image-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .feedback-btn {
            width: 120px;
            margin: 0.5rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .note {
            font-size: 0.8rem;
            color: #6b6b8c;
            margin-top: -0.5rem;
            margin-bottom: 1rem;
        }

        @media (max-width: 600px) {
            body {
                padding: 1rem;
            }

            .tab-links {
                flex-direction: column;
                gap: 0.5rem;
            }

            .tab-links li a {
                padding: 0.5rem;
            }

            #image_output img, #history_output img {
                max-width: 100%;
            }
        }
    </style>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap">
</head>
<body>
    <div id="auth_ui">
        <ul class="tab-links">
            <li><a href="#" data-tab="signup">Sign Up</a></li>
            <li><a href="#" data-tab="login">Login</a></li>
        </ul>
        <div class="tab-content">
            <div id="signup">
                <h2>Sign Up</h2>
                <p>Create a new account with your industry code</p>
                <label>Username</label><input id="signup_username" type="text">
                <label>Password</label><input id="signup_password" type="password">
                <label>Industry Code</label><input id="industry_code" type="text" placeholder="e.g., TECH-123">
                <label>Template</label><select id="template_dropdown" disabled><option value="null">None</option></select>
                <div class="note">Enter your industry-specific code for future features</div>
                <button id="signup_btn" class="primary-btn">Create Account</button>
                <div id="signup_status" class="output"></div>
            </div>
            <div id="login">
                <h2>Login</h2>
                <p>Access your existing account</p>
                <label>Username</label><input id="login_username" type="text">
                <label>Password</label><input id="login_password" type="password">
                <button id="login_btn" class="primary-btn">Login</button>
                <div id="login_status" class="output"></div>
            </div>
        </div>
    </div>
    <div id="post_login_ui" style="display:none;">
        <!-- Filled dynamically -->
    </div>
    <script>
        // Tab switching
        function setupTabs(container) {
            const tabLinks = container.querySelectorAll('.tab-links a');
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    tabLinks.forEach(l => l.classList.remove('active'));
                    link.classList.add('active');
                    const tabId = link.dataset.tab;
                    container.querySelectorAll('.tab-content > div').forEach(d => d.classList.remove('active'));
                    container.querySelector(`#${tabId}`).classList.add('active');
                });
            });
            if (tabLinks.length > 0) tabLinks[0].click();
        }
        setupTabs(document.getElementById('auth_ui'));

        // UserManager
        class UserManager {
            constructor() {
                this.USER_DB_KEY = "user_database";
                this.TEMPLATE_DB_KEY = "templates";
                this.MASTER_USERNAME = "master123";
                this.DEFAULT_MASTER_PASSWORD = "master@123";
                this.users = JSON.parse(localStorage.getItem(this.USER_DB_KEY)) || {};
                this.templates = JSON.parse(localStorage.getItem(this.TEMPLATE_DB_KEY)) || {};
                this.current_user = null;
                this.current_role = null;
                this.create_master_user();
            }
            async create_master_user() {
                if (!this.users[this.MASTER_USERNAME]) {
                    const salt = crypto.getRandomValues(new Uint8Array(16));
                    const hashed_pw = await this.hashPassword(this.DEFAULT_MASTER_PASSWORD, salt);
                    this.users[this.MASTER_USERNAME] = {
                        "password": this.arrayBufferToHex(hashed_pw),
                        "salt": this.arrayBufferToHex(salt),
                        "industry_code": "ADMIN-001",
                        "role": "master",
                        "created_at": new Date().toISOString().slice(0,19).replace('T',' '),
                        "template_id": null
                    };
                    this.save_users();
                }
            }
            save_users() {
                localStorage.setItem(this.USER_DB_KEY, JSON.stringify(this.users));
            }
            save_templates() {
                localStorage.setItem(this.TEMPLATE_DB_KEY, JSON.stringify(this.templates));
            }
            async hashPassword(password, salt) {
                const encoder = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey(
                    "raw", encoder.encode(password), { name: "PBKDF2" }, false, ["deriveBits"]
                );
                const hash = await crypto.subtle.deriveBits(
                    { name: "PBKDF2", salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, 256
                );
                return hash;
            }
            arrayBufferToHex(buffer) {
                return Array.from(new Uint8Array(buffer)).map(b => b.toString(16).padStart(2, '0')).join('');
            }
            async create_user(username, password, industry_code, template_id = null) {
                if (this.users[username]) return {success: false, message: "Username already exists"};
                const role = username === this.MASTER_USERNAME ? "master" : "client";
                if (template_id && !this.templates[template_id]) return {success: false, message: "Invalid template ID"};
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const hashed_pw = await this.hashPassword(password, salt);
                this.users[username] = {
                    "password": this.arrayBufferToHex(hashed_pw),
                    "salt": this.arrayBufferToHex(salt),
                    "industry_code": industry_code,
                    "role": role,
                    "created_at": new Date().toISOString().slice(0,19).replace('T',' '),
                    "template_id": template_id
                };
                this.save_users();
                return {success: true, message: `Account created successfully. Role: ${role}`};
            }
            async authenticate(username, password) {
                if (!this.users[username]) return {success: false, message: "User not found"};
                const user = this.users[username];
                const salt = Uint8Array.from(user["salt"].match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const hashed_pw = await this.hashPassword(password, salt);
                if (this.arrayBufferToHex(hashed_pw) !== user["password"]) return {success: false, message: "Invalid password"};
                this.current_user = username;
                this.current_role = user["role"];
                return {success: true, message: `Login successful. Role: ${user["role"]}`};
            }
            logout() {
                this.current_user = null;
                this.current_role = null;
                return "You have been logged out";
            }
            create_template(template_name, industry_code, content, creator) {
                if (creator !== this.MASTER_USERNAME || this.current_role !== "master") return {success: false, message: "Only master users can create templates"};
                const template_id = crypto.randomUUID();
                this.templates[template_id] = {
                    "name": template_name,
                    "industry_code": industry_code,
                    "content": content,
                    "created_at": new Date().toISOString().slice(0,19).replace('T',' ')
                };
                this.save_templates();
                return {success: true, message: `Template '${template_name}' created with ID: ${template_id}`};
            }
            delete_template(template_id, user) {
                if (user !== this.MASTER_USERNAME || this.current_role !== "master") return {success: false, message: "Only master users can delete templates"};
                if (!this.templates[template_id]) return {success: false, message: "Template not found"};
                for (const u in this.users) {
                    if (this.users[u].template_id === template_id) return {success: false, message: "Template is assigned to users and cannot be deleted"};
                }
                delete this.templates[template_id];
                this.save_templates();
                return {success: true, message: `Template ${template_id} deleted successfully`};
            }
            get_templates_by_industry(industry_code) {
                const matching = {};
                for (const tid in this.templates) {
                    if (this.templates[tid].industry_code === industry_code) matching[tid] = this.templates[tid];
                }
                return matching;
            }
            async update_user(username, current_password, new_industry_code = null, new_template_id = null, new_password = null) {
                if (!this.users[username]) return {success: false, message: "User not found"};
                const user = this.users[username];
                const salt = Uint8Array.from(user["salt"].match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
                const hashed_pw = await this.hashPassword(current_password, salt);
                if (this.arrayBufferToHex(hashed_pw) !== user["password"]) return {success: false, message: "Current password is incorrect"};
                if (new_industry_code !== null) user["industry_code"] = new_industry_code;
                if (new_template_id !== null) {
                    if (new_template_id && !this.templates[new_template_id]) return {success: false, message: "Invalid template ID"};
                    user["template_id"] = new_template_id;
                }
                if (new_password) {
                    const new_salt = crypto.getRandomValues(new Uint8Array(16));
                    const new_hashed_pw = await this.hashPassword(new_password, new_salt);
                    user["password"] = this.arrayBufferToHex(new_hashed_pw);
                    user["salt"] = this.arrayBufferToHex(new_salt);
                }
                this.save_users();
                return {success: true, message: "Account updated successfully"};
            }
        }

        // HistoryManager
        class HistoryManager {
            constructor() {
                this.HISTORY_KEY = "image_history";
                this.MAX_HISTORY = 3;
                this.history = JSON.parse(localStorage.getItem(this.HISTORY_KEY)) || {};
            }
            save_history() {
                localStorage.setItem(this.HISTORY_KEY, JSON.stringify(this.history));
            }
            record_session(username, session_data) {
                if (!this.history[username]) this.history[username] = [];
                this.history[username].push(session_data);
                if (this.history[username].length > this.MAX_HISTORY) {
                    this.history[username] = this.history[username].slice(-this.MAX_HISTORY);
                }
                this.save_history();
            }
            get_user_history(username) {
                return this.history[username] || [];
            }
        }

        // Image functions
        async function getPollinationsImage(prompt) {
            try {
                const seed = Math.floor(Math.random() * 1000000);
                const encoded_prompt = encodeURIComponent(prompt);
                const api_url = `https://image.pollinations.ai/prompt/${encoded_prompt}?seed=${seed}&width=1024&height=1024`;
                const response = await fetch(api_url, {timeout: 60000});
                if (!response.ok) throw new Error('Failed');
                const blob = await response.blob();
                return blob;
            } catch (e) {
                console.log(`Image generation failed: ${e}`);
                return null;
            }
        }
        async function generateTwoImages(subject, style = "professional photography") {
            const base_prompt = `A photorealistic 1024x1024 image of ${subject}, ${style}, high quality, 8k`;
            const images = [];
            for (let i = 0; i < 2; i++) {
                const variation_prompt = `${base_prompt}, variation ${i+1}, unique composition`;
                const img_blob = await getPollinationsImage(variation_prompt);
                images.push(img_blob);
                await new Promise(resolve => setTimeout(resolve, 1000));
            }
            return images;
        }

        // AuthImageSystem
        class AuthImageSystem {
            constructor() {
                this.user_manager = new UserManager();
                this.history_manager = new HistoryManager();
                this.current_images = [];
                this.current_subject = "";
                this.current_style = "";
                this.regeneration_count = 0;
                this.MAX_REGENERATIONS = 20;
                this.attachHandlers();
            }
            attachHandlers() {
                document.getElementById('signup_btn').addEventListener('click', async () => this.on_signup());
                document.getElementById('login_btn').addEventListener('click', async () => this.on_login());
                document.getElementById('industry_code').addEventListener('input', (e) => this.update_template_dropdown(e.target.value));
            }
            update_template_dropdown(industry_code) {
                industry_code = industry_code.trim();
                const templates = this.user_manager.get_templates_by_industry(industry_code);
                let options = '<option value="null">None</option>';
                for (const tid in templates) {
                    options += `<option value="${tid}">${templates[tid].name}</option>`;
                }
                const dropdown = document.getElementById('template_dropdown');
                dropdown.innerHTML = options;
                dropdown.disabled = Object.keys(templates).length === 0;
            }
            update_account_template_dropdown(industry_code) {
                industry_code = industry_code.trim();
                const templates = this.user_manager.get_templates_by_industry(industry_code);
                let options = '<option value="null">None</option>';
                for (const tid in templates) {
                    options += `<option value="${tid}">${templates[tid].name}</option>`;
                }
                const dropdown = document.getElementById('account_template_dropdown');
                dropdown.innerHTML = options;
                dropdown.disabled = Object.keys(templates).length === 0;
            }
            async on_signup() {
                const username = document.getElementById('signup_username').value.trim();
                const password = document.getElementById('signup_password').value.trim();
                const industry_code = document.getElementById('industry_code').value.trim();
                const template_id = document.getElementById('template_dropdown').value === 'null' ? null : document.getElementById('template_dropdown').value;
                const status = document.getElementById('signup_status');
                status.innerHTML = '';
                if (!username || !password) {
                    status.innerHTML = `<div style="color:#f28b82">Username and password are required!</div>`;
                    return;
                }
                if (!industry_code) {
                    status.innerHTML = `<div style="color:#f28b82">Industry code is required!</div>`;
                    return;
                }
                const {success, message} = await this.user_manager.create_user(username, password, industry_code, template_id);
                const color = success ? "#81c784" : "#f28b82";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
            }
            async on_login() {
                const username = document.getElementById('login_username').value.trim();
                const password = document.getElementById('login_password').value.trim();
                const status = document.getElementById('login_status');
                status.innerHTML = '';
                if (!username || !password) {
                    status.innerHTML = `<div style="color:#f28b82">Username and password required!</div>`;
                    return;
                }
                const {success, message} = await this.user_manager.authenticate(username, password);
                const color = success ? "#81c784" : "#f28b82";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                if (success) {
                    setTimeout(() => {
                        document.getElementById('auth_ui').style.display = 'none';
                        this.show_post_login_ui();
                    }, 3000);
                }
            }
            show_post_login_ui() {
                const container = document.getElementById('post_login_ui');
                container.style.display = 'block';
                const role = this.user_manager.current_role;
                const username = this.user_manager.current_user;
                let html = `
                    <div class="header">
                        <h2>Logged in as: ${username} (${role})</h2>
                        <button id="logout_btn" class="logout-btn">Logout</button>
                    </div>
                    <ul class="tab-links">
                `;
                if (role === "master") {
                    html += `
                        <li><a href="#" data-tab="image_gen">Image Generator</a></li>
                        <li><a href="#" data-tab="template_mgmt">Template Management</a></li>
                        <li><a href="#" data-tab="history">Past Records</a></li>
                        <li><a href="#" data-tab="account">Account</a></li>
                    </ul>
                    <div class="tab-content">
                        ${this.get_image_gen_html()}
                        ${this.get_template_mgmt_html()}
                        ${this.get_history_html()}
                        ${this.get_account_html()}
                    </div>
                `;
                } else {
                    html += `
                        <li><a href="#" data-tab="image_gen">Image Generator</a></li>
                        <li><a href="#" data-tab="history">Past Records</a></li>
                        <li><a href="#" data-tab="account">Account</a></li>
                    </ul>
                    <div class="tab-content">
                        ${this.get_image_gen_html()}
                        ${this.get_history_html()}
                        ${this.get_account_html()}
                    </div>
                `;
                }
                container.innerHTML = html;
                setupTabs(container);
                document.getElementById('logout_btn').addEventListener('click', () => this.on_logout());
                if (role === "master") {
                    document.getElementById('create_template_btn').addEventListener('click', () => this.on_create_template());
                    document.getElementById('delete_template_btn').addEventListener('click', () => this.on_delete_template());
                    this.update_template_delete_dropdown();
                }
                document.getElementById('generate_btn').addEventListener('click', async () => this.on_generate());
                document.getElementById('refresh_history_btn').addEventListener('click', () => this.display_history());
                document.getElementById('update_account_btn').addEventListener('click', () => this.on_account_update());
                document.getElementById('account_industry_code').addEventListener('input', (e) => this.update_account_template_dropdown(e.target.value));
                const user = this.user_manager.users[this.user_manager.current_user];
                if (user) {
                    document.getElementById('account_username').value = this.user_manager.current_user;
                    document.getElementById('account_industry_code').value = user.industry_code;
                    document.getElementById('account_template_dropdown').value = user.template_id || 'null';
                    this.update_account_template_dropdown(user.industry_code);
                }
                const template_id = user?.template_id;
                if (template_id && this.user_manager.templates[template_id]) {
                    document.getElementById('image_style').value = this.user_manager.templates[template_id].content;
                }
            }
            get_image_gen_html() {
                return `
                    <div id="image_gen">
                        <h2>Image Generator</h2>
                        <p>Enter a subject and style to generate two images</p>
                        <label>Subject</label><input id="image_subject" type="text" placeholder="e.g., Spicy Tuna Roll, Mystery Novel, Smart Watch">
                        <label>Style</label><input id="image_style" type="text" value="professional photography">
                        <button id="generate_btn" class="primary-btn">Generate Images</button>
                        <div id="image_output" class="output"></div>
                        <div id="feedback_status" class="output"></div>
                    </div>
                `;
            }
            get_template_mgmt_html() {
                return `
                    <div id="template_mgmt">
                        <h2>Template Management</h2>
                        <p>Create or delete industry-specific templates (Master only)</p>
                        <label>Template Name</label><input id="template_name" type="text">
                        <label>Industry Code</label><input id="template_industry_code" type="text">
                        <label>Content</label><input id="template_content" type="text" placeholder="e.g., professional photography, Japanese cuisine">
                        <button id="create_template_btn" class="primary-btn">Create Template</button>
                        <label>Delete Template</label><select id="delete_template_dropdown"><option value="null">Select a template</option></select>
                        <button id="delete_template_btn" class="danger-btn">Delete Template</button>
                        <div id="template_status" class="output"></div>
                    </div>
                `;
            }
            get_history_html() {
                return `
                    <div id="history">
                        <h2>Past Records</h2>
                        <p>Your last 3 image generation sessions</p>
                        <button id="refresh_history_btn" class="secondary-btn">Refresh History</button>
                        <div id="history_output" class="output"></div>
                    </div>
                `;
            }
            get_account_html() {
                return `
                    <div id="account">
                        <h2>Account Management</h2>
                        <p>Update your account information</p>
                        <label>Username</label><input id="account_username" type="text" disabled>
                        <label>Industry Code</label><input id="account_industry_code" type="text">
                        <label>Template</label><select id="account_template_dropdown"><option value="null">None</option></select>
                        <label>Current Password</label><input id="current_password" type="password">
                        <label>New Password</label><input id="new_password" type="password" placeholder="Leave blank to keep current">
                        <label>Confirm Password</label><input id="confirm_password" type="password">
                        <div class="note">Leave password fields unchanged to keep current password</div>
                        <button id="update_account_btn" class="primary-btn">Update Account</button>
                        <div id="account_status" class="output"></div>
                    </div>
                `;
            }
            on_logout() {
                const message = this.user_manager.logout();
                const container = document.getElementById('post_login_ui');
                container.innerHTML = `<div style="color:#a3a8f0;padding:0.75rem">${message}</div>`;
                setTimeout(() => {
                    container.style.display = 'none';
                    document.getElementById('auth_ui').style.display = 'block';
                }, 2000);
            }
            on_create_template() {
                if (this.user_manager.current_role !== "master") {
                    document.getElementById('template_status').innerHTML = `<div style="color:#f28b82">Only master users can create templates!</div>`;
                    return;
                }
                const template_name = document.getElementById('template_name').value.trim();
                const industry_code = document.getElementById('template_industry_code').value.trim();
                const content = document.getElementById('template_content').value.trim();
                const status = document.getElementById('template_status');
                status.innerHTML = '';
                if (!template_name || !industry_code || !content) {
                    status.innerHTML = `<div style="color:#f28b82">All template fields are required!</div>`;
                    return;
                }
                const {success, message} = this.user_manager.create_template(template_name, industry_code, content, this.user_manager.current_user);
                const color = success ? "#81c784" : "#f28b82";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                this.update_template_delete_dropdown();
                this.update_account_template_dropdown(document.getElementById('account_industry_code').value);
            }
            on_delete_template() {
                if (this.user_manager.current_role !== "master") {
                    document.getElementById('template_status').innerHTML = `<div style="color:#f28b82">Only master users can delete templates!</div>`;
                    return;
                }
                const template_id = document.getElementById('delete_template_dropdown').value;
                const status = document.getElementById('template_status');
                status.innerHTML = '';
                if (!template_id || template_id === 'null') {
                    status.innerHTML = `<div style="color:#f28b82">Select a template to delete!</div>`;
                    return;
                }
                const {success, message} = this.user_manager.delete_template(template_id, this.user_manager.current_user);
                const color = success ? "#81c784" : "#f28b82";
                status.innerHTML = `<div style="color:${color}">${message}</div>`;
                this.update_template_delete_dropdown();
                this.update_account_template_dropdown(document.getElementById('account_industry_code').value);
            }
            update_template_delete_dropdown() {
                const templates = this.user_manager.templates;
                let options = '<option value="null">Select a template</option>';
                for (const tid in templates) {
                    const t = templates[tid];
                    options += `<option value="${tid}">${t.name} (${t.industry_code})</option>`;
                }
                document.getElementById('delete_template_dropdown').innerHTML = options;
            }
            async on_generate() {
                const subject = document.getElementById('image_subject').value.trim();
                const style = document.getElementById('image_style').value.trim();
                const output = document.getElementById('image_output');
                output.innerHTML = '';
                if (!subject) {
                    output.innerHTML = `<div style="color:#f28b82">Subject is required!</div>`;
                    return;
                }
                this.regeneration_count = 0;
                this.current_subject = subject;
                this.current_style = style;
                output.innerHTML = `<div style="color:#a3a8f0">Generating images, please wait...</div>`;
                await this.generate_and_display_images();
            }
            async generate_and_display_images() {
                const output = document.getElementById('image_output');
                const images = await generateTwoImages(this.current_subject, this.current_style);
                this.current_images = images;
                if (this.user_manager.current_user && images.some(img => img !== null)) {
                    const session_data = {
                        subject: this.current_subject,
                        style: this.current_style,
                        timestamp: new Date().toISOString().slice(0,19).replace('T',' '),
                        images: await Promise.all(images.map(async img => img ? await this.blobToBase64(img) : null))
                    };
                    this.history_manager.record_session(this.user_manager.current_user, session_data);
                }
                output.innerHTML = '';
                if (images.every(img => img === null)) {
                    output.innerHTML += `<div style="color:#f28b82">Failed to generate images.</div>`;
                    return;
                }
                images.forEach((img, i) => {
                    if (img) {
                        const url = URL.createObjectURL(img);
                        output.innerHTML += `<h3>Image ${i+1}</h3><img src="${url}" alt="Generated Image ${i+1}">`;
                    }
                });
                output.innerHTML += `
                    <div>
                        <button id="like_this_btn" class="feedback-btn primary-btn">I like this</button>
                        <button id="like_that_btn" class="feedback-btn primary-btn">I like that</button>
                        <button id="both_bad_btn" class="feedback-btn danger-btn">Both bad</button>
                    </div>
                `;
                if (this.regeneration_count > 0) {
                    output.innerHTML += `<div style="color:#a3a8f0">Regeneration attempt: ${this.regeneration_count}/${this.MAX_REGENERATIONS}</div>`;
                }
                document.getElementById('like_this_btn').addEventListener('click', () => this.on_like_this());
                document.getElementById('like_that_btn').addEventListener('click', () => this.on_like_that());
                document.getElementById('both_bad_btn').addEventListener('click', () => this.on_both_bad());
            }
            async blobToBase64(blob) {
                if (!blob) return null;
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.readAsDataURL(blob);
                });
            }
            async on_like_this() {
                if (this.current_images.length > 0 && this.current_images[0]) {
                    const filename = `${this.current_subject.replace(/ /g, '_')}_1.png`;
                    const html = await this.download_image(this.current_images[0], filename);
                    document.getElementById('feedback_status').innerHTML = `<div style="color:#81c784;padding:0.75rem">${html}</div>`;
                }
            }
            async on_like_that() {
                if (this.current_images.length > 1 && this.current_images[1]) {
                    const filename = `${this.current_subject.replace(/ /g, '_')}_2.png`;
                    const html = await this.download_image(this.current_images[1], filename);
                    document.getElementById('feedback_status').innerHTML = `<div style="color:#81c784;padding:0.75rem">${html}</div>`;
                }
            }
            async on_both_bad() {
                this.regeneration_count += 1;
                const output = document.getElementById('image_output');
                if (this.regeneration_count >= this.MAX_REGENERATIONS) {
                    output.innerHTML = `<div style="color:#f28b82">Maximum regenerations reached. Please try a different subject.</div>`;
                    return;
                }
                output.innerHTML = `<div style="color:#a3a8f0">Regenerating images (attempt ${this.regeneration_count}/${this.MAX_REGENERATIONS})...</div>`;
                await this.generate_and_display_images();
            }
            async download_image(img_blob, filename) {
                const reader = new FileReader();
                return new Promise((resolve) => {
                    reader.onload = () => {
                        const b64 = reader.result.split(',')[1];
                        const html = `
                            <a download="${filename}" href="data:image/png;base64,${b64}" target="_blank">
                                Click to download ${filename}
                            </a>
                        `;
                        resolve(html);
                    };
                    reader.readAsDataURL(img_blob);
                });
            }
            async display_history() {
                const output = document.getElementById('history_output');
                output.innerHTML = '';
                if (!this.user_manager.current_user) {
                    output.innerHTML = `<div style="color:#f28b82;padding:0.75rem">Not logged in</div>`;
                    return;
                }
                const username = this.user_manager.current_user;
                const user_history = this.history_manager.get_user_history(username);
                if (!user_history.length) {
                    output.innerHTML = `<div style="padding:0.75rem">No history found. Generate some images first!</div>`;
                    return;
                }
                output.innerHTML = `<h3>History for ${username}</h3><p>Showing last ${this.history_manager.MAX_HISTORY} sessions</p>`;
                user_history.slice().reverse().forEach((session, i) => {
                    output.innerHTML += `
                        <div class="session-container">
                            <h4>Session ${i+1}: ${session.timestamp}</h4>
                            <p><b>Subject:</b> ${session.subject}</p>
                            <p><b>Style:</b> ${session.style}</p>
                            <div class="image-container">
                    `;
                    session.images.forEach((img_base64, j) => {
                        if (img_base64) {
                            output.innerHTML += `
                                <div style="display:inline-block; margin-right:1rem;">
                                    <img src="data:image/png;base64,${img_base64}" alt="History Image ${j+1}">
                                    <button class="download_history_btn primary-btn" data-img="${img_base64}" data-subject="${session.subject}" data-index="${j+1}">Download Image ${j+1}</button>
                                </div>
                            `;
                        }
                    });
                    output.innerHTML += `</div></div>`;
                });
                document.querySelectorAll('.download_history_btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const img_base64 = btn.dataset.img;
                        const subject = btn.dataset.subject;
                        const index = btn.dataset.index;
                        const filename = `${subject.replace(/ /g, '_')}_${index}.png`;
                        const html = `
                            <a download="${filename}" href="data:image/png;base64,${img_base64}" target="_blank">
                                Click to download ${filename}
                            </a>
                        `;
                        output.innerHTML = `<div style="color:#81c784;padding:0.75rem">${html}</div>`;
                        setTimeout(() => this.display_history(), 0); // Refresh history
                    });
                });
            }
            async on_account_update() {
                if (!this.user_manager.current_user) {
                    document.getElementById('account_status').innerHTML = `<div style="color:#f28b82;padding:0.75rem">Not logged in</div>`;
                    return;
                }
                const username = this.user_manager.current_user;
                const current_password = document.getElementById('current_password').value.trim();
                const new_industry_code = document.getElementById('account_industry_code').value.trim();
                const new_template_id = document.getElementById('account_template_dropdown').value === 'null' ? null : document.getElementById('account_template_dropdown').value;
                const new_password = document.getElementById('new_password').value.trim();
                const confirm_password = document.getElementById('confirm_password').value.trim();
                const status = document.getElementById('account_status');
                status.innerHTML = '';
                if (!current_password) {
                    status.innerHTML = `<div style="color:#f28b82;padding:0.75rem">Current password is required</div>`;
                    return;
                }
                if (new_password && new_password !== confirm_password) {
                    status.innerHTML = `<div style="color:#f28b82;padding:0.75rem">New passwords do not match</div>`;
                    return;
                }
                if (!new_industry_code) {
                    status.innerHTML = `<div style="color:#f28b82;padding:0.75rem">Industry code is required</div>`;
                    return;
                }
                const {success, message} = await this.user_manager.update_user(
                    username, current_password, new_industry_code, new_template_id, new_password || null
                );
                const color = success ? "#81c784" : "#f28b82";
                status.innerHTML = `<div style="color:${color};padding:0.75rem">${message}</div>`;
                document.getElementById('current_password').value = '';
                document.getElementById('new_password').value = '';
                document.getElementById('confirm_password').value = '';
                this.update_template_dropdown(document.getElementById('industry_code').value);
                this.update_account_template_dropdown(new_industry_code);
            }
        }
        const auth_image_system = new AuthImageSystem();
    </script>
</body>
</html>